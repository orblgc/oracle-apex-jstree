function initMyJsTree(regionstaticid,containerSelector,ajaxId,searchItem,initItems,ajaxItems,dropItems,useAjax,useDrop,configJson,drop_success_message,drop_error_message){var $=apex.jQuery,tree$=$("#"+containerSelector),config={};try{config=eval("("+configJson+")")}catch(e){console.error("Invalid config JSON:",configJson)}var selectionMap=config.selectionMap||[],jsTreeConfig={core:{worker:!1,check_callback:!0,themes:{name:"proton",dots:!0,icons:!0},force_text:!0,multiple:!1,dblclick_toggle:!1},plugins:[]};config.contextMenu&&(jsTreeConfig.plugins.push("contextmenu"),jsTreeConfig.contextmenu={items:function(e){var t=this,a=e.original.type,n=config.contextMenu[a]||[],o={};return n.forEach((function(e,a){var n=e.callback;o[n||"action_"+a]={label:"function"==typeof e.label?e.label():e.label,icon:e.icon||!1,separator_before:e.separator_before||!1,separator_after:e.separator_after||!1,_disabled:e._disabled||!1,title:e.title||"",shortcut:e.shortcut||void 0,shortcut_label:e.shortcut_label||void 0,submenu:e.submenu||void 0,action:function(a){var o=!0===e.returnAllSelected?t.get_selected():t.get_node(a.reference);n&&"function"==typeof window[n]?window[n](o):console.warn("Callback for",n,"not found")}}})),o}}),"boolean"==typeof config.force_text&&(jsTreeConfig.core.force_text=config.force_text),"boolean"==typeof config.multiple&&(jsTreeConfig.core.multiple=config.multiple),"boolean"==typeof config.dblclick_toggle&&(jsTreeConfig.core.dblclick_toggle=config.dblclick_toggle),jsTreeConfig.core.data=function(e,t){var a="#"===e.id;if("Y"==useAjax||a){var n=e.li_attr?.["data-type"],o=a?"INITIAL":"LOAD",r={x01:e.id,x02:o,x03:n};(a&&initItems||!a&&ajaxItems)&&(r.pageItems=(a?initItems:ajaxItems).split(",").map((e=>"#"+e.trim())).join(",")),apex.server.plugin(ajaxId,r,{dataType:"json",success:function(e){var a=(e.row||[]).map((function(e){return{id:e.NODE_ID,parent:e.PARENT_ID,text:e.TEXT,icon:e.ICON,type:e.TYPE,state:{opened:1==e.STATE_OPENED,selected:1==e.STATE_SELECTED,disabled:1==e.STATE_DISABLED},li_attr:{"data-type":e.TYPE,"data-value":e.VALUE},a_attr:{"data-href":e.HREF},checkbox:1==e.CHECKBOX,unselectable:1==e.UNSELECTABLE}}));t(a)}})}else t([])},searchItem&&(jsTreeConfig.plugins.push("search"),jsTreeConfig.search={show_only_matches:!0,show_only_matches_children:!0}),config.enableCheckbox&&(jsTreeConfig.plugins.push("checkbox"),jsTreeConfig.checkbox={cascade:config.checkboxCascade||"down",three_state:!1!==config.threeState,cascade_to_hidden:config.cascade_to_hidden||!1});var mobile=/Android|iPhone|iPad|iPod|Windows Phone/i.test(navigator.userAgent);if("Y"===useDrop&&(mobile&&config.dndAllowMobile||!mobile)&&(jsTreeConfig.plugins.push("dnd"),config.dndRules&&(jsTreeConfig.core.dnd={check_while_dragging:!0})),jsTreeConfig.core.check_callback=function(e,t,a,n,o){if("move_node"===e&&config.dndRules)try{var r=t.li_attr?.["data-type"],i=a.li_attr?.["data-type"];if(i||"#"!==a.id||(i="#"),!r||!i)return!0;var s=config.dndRules[r];return!Array.isArray(s)||s.includes(i)}catch(e){return console.error("DnD check failed:",e),!0}return!0},tree$.jstree(jsTreeConfig),"dblclick"===config.nodeLinkOpenOn){var tapped=!1,target;tree$.on("click.jstree",(function(e){if(tapped){if(target==e.target){clearTimeout(tapped),tapped=null;const t=$(e.target).closest("a"),a=t.data("href");a&&("_blank"==t.data("target")?apex.navigation.openInNewWindow(a):apex.navigation.redirect(a))}}else target=e.target,tapped=setTimeout((function(){tapped=null}),300);e.preventDefault()}))}else tree$.on("activate_node.jstree",(function(e,t){const a=t.node.a_attr["data-href"];a&&("_blank"==t.node.a_attr["data-target"]?apex.navigation.openInNewWindow(a):apex.navigation.redirect(a))}));function updateSelections(){var e={};tree$.jstree(!0).get_selected().forEach((function(t){var a=tree$.jstree(!0).get_node(t),n=a.li_attr["data-type"],o=a.li_attr["data-value"];n&&o&&(e[n]=e[n]||[],e[n].push(o))})),selectionMap.forEach((function(t){var a=e[t.type]||[];apex.item(t.itemName).setValue(a.join(":"))}))}tree$.on("changed.jstree",updateSelections),tree$.on("open_node.jstree",(function(){setTimeout(updateSelections,0)})),"Y"===useDrop&&tree$.on("move_node.jstree",(function(e,t){var a=t.instance.get_node(t.parent),n=a?.li_attr?.["data-value"]||null,o=a?.li_attr?.["data-type"]||null,r=t.instance.get_node(t.old_parent),i=r?.li_attr?.["data-value"]||null,s=r?.li_attr?.["data-type"]||null,c=t.node?.li_attr?.["data-value"]||null,l=t.node?.li_attr?.["data-type"]||null,d={x01:c,x02:"ON_DROP",x03:i,x04:n,x05:t.old_position,x06:t.position,x07:s,x08:o,x09:l};dropItems&&(d.pageItems=dropItems.split(",").map((e=>"#"+e.trim())).join(",")),apex.server.plugin(ajaxId,d,{dataType:"json",success:function(e){apex.message.clearErrors(),e.success?drop_success_message&&apex.message.showPageSuccess(drop_success_message):drop_error_message&&apex.message.showErrors([{type:"error",location:["page","inline"],message:drop_error_message,unsafe:!1}])}})})),searchItem&&$("#"+searchItem).on("keydown",(function(e){"Enter"===e.key&&tree$.jstree(!0).search(this.value)})),$("#"+regionstaticid).on("apexrefresh",(function(){tree$.jstree().refresh({skip_loading:config.skip_loading||!1})}))}